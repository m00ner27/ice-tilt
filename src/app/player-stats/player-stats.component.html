<div class="player-stats-container">
  <h1 class="player-stats-title">Player Statistics</h1>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <p>Loading seasons...</p>
  </div>

  <!-- Processing Stats Indicator -->
  <div *ngIf="isProcessingStats && !isLoading" class="loading-container">
    <p>Processing player statistics...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading">
    <!-- Season and Division Selectors -->
    <div class="filters-container">
      <div class="filter-group">
        <label for="season-select">Season:</label>
        <select id="season-select" [(ngModel)]="selectedSeasonId" (ngModelChange)="onSeasonChange()">
          <option value="all-seasons">All-Time</option>
          <option *ngFor="let season of seasons" [value]="season._id">{{ season.name }}</option>
        </select>
      </div>
      
      <div class="filter-group" *ngIf="selectedSeasonId !== 'all-seasons'">
        <label for="division-select">Division:</label>
        <select id="division-select" [(ngModel)]="selectedDivisionId" (ngModelChange)="onDivisionChange()">
          <option value="all-divisions">All Divisions</option>
          <option *ngFor="let division of divisions" [value]="division._id">{{ division.name }}</option>
        </select>
      </div>
    </div>

    <!-- Stats Tables per Division -->
    <div *ngIf="isProcessingStats && !isLoading" class="division-group">
      <app-skeleton-loader type="table" [count]="10" containerClass="w-full"></app-skeleton-loader>
    </div>
    
    <div *ngFor="let group of filteredGroupedStats" class="division-group">
      <h2 *ngIf="selectedSeasonId !== 'all-seasons'" class="division-header">
        <img *ngIf="group.divisionData?.logoUrl" 
             [src]="getImageUrl(group.divisionData?.logoUrl)" 
             [alt]="group.division + ' logo'" 
             class="division-logo"
             (error)="onImageError($event)">
        {{ group.division }}
      </h2>
      
      <div class="player-stats-table-container">
        <table class="player-stats-table">
          <thead>
            <tr>
              <th class="sticky-column rank-column">Rank</th>
              <th class="sticky-column player-name" [ngClass]="getColumnSortClass('name')" (click)="onSortColumn('name')">Player</th>
              <th [ngClass]="getColumnSortClass('team')" (click)="onSortColumn('team')">Club</th>
              <th [className]="getColumnSortClass('position')" (click)="onSortColumn('position')">Pos</th>
              <th [className]="getColumnSortClass('gamesPlayed')" (click)="onSortColumn('gamesPlayed')">GP</th>
              <th [className]="getColumnSortClass('goals')" (click)="onSortColumn('goals')">G</th>
              <th [className]="getColumnSortClass('assists')" (click)="onSortColumn('assists')">A</th>
              <th [className]="getColumnSortClass('points')" (click)="onSortColumn('points')">PTS</th>
              <th [className]="getColumnSortClass('plusMinus')" (click)="onSortColumn('plusMinus')">+/-</th>

              <th [className]="getColumnSortClass('shots')" (click)="onSortColumn('shots')">S</th>
              <th [className]="getColumnSortClass('shotPercentage')" (click)="onSortColumn('shotPercentage')">S%</th>
              <th [className]="getColumnSortClass('hits')" (click)="onSortColumn('hits')">H</th>
              <th [className]="getColumnSortClass('blockedShots')" (click)="onSortColumn('blockedShots')">BS</th>
              <th [className]="getColumnSortClass('penaltyMinutes')" (click)="onSortColumn('penaltyMinutes')">PIM</th>
              <th [className]="getColumnSortClass('powerPlayGoals')" (click)="onSortColumn('powerPlayGoals')">PPG</th>
              <th [className]="getColumnSortClass('shortHandedGoals')" (click)="onSortColumn('shortHandedGoals')">SHG</th>
              <th [className]="getColumnSortClass('gameWinningGoals')" (click)="onSortColumn('gameWinningGoals')">GWG</th>
              <th [className]="getColumnSortClass('interceptions')" (click)="onSortColumn('interceptions')">INT</th>
              <th [className]="getColumnSortClass('takeaways')" (click)="onSortColumn('takeaways')">TK</th>
              <th [className]="getColumnSortClass('giveaways')" (click)="onSortColumn('giveaways')">GV</th>
              <th [className]="getColumnSortClass('passAttempts')" (click)="onSortColumn('passAttempts')">PA</th>
              <th [className]="getColumnSortClass('passes')" (click)="onSortColumn('passes')">P</th>
              <th [className]="getColumnSortClass('passPercentage')" (click)="onSortColumn('passPercentage')">P%</th>
              <th [className]="getColumnSortClass('faceoffsWon')" (click)="onSortColumn('faceoffsWon')">FOW</th>
              <th [className]="getColumnSortClass('faceoffsLost')" (click)="onSortColumn('faceoffsLost')">FOL</th>
              <th [className]="getColumnSortClass('faceoffPercentage')" (click)="onSortColumn('faceoffPercentage')">FO%</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let player of group.stats; let i = index">
              <td class="sticky-column rank-column">{{ i + 1 }}</td>
              <td class="sticky-column player-name">
                <div class="player-name-container">
                  <img [src]="player.teamLogo" class="player-logo" [alt]="player.team + ' logo'">
                  <span class="player-name-text">{{ player.name }}</span>
                </div>
              </td>
              <td class="team-cell">
                <span class="team-name">{{ player.team }}</span>
              </td>
              <td>{{ player.position }}</td>
              <td>{{ player.gamesPlayed }}</td>
              <td>{{ player.goals }}</td>
              <td>{{ player.assists }}</td>
              <td class="points-column">{{ player.points }}</td>
              <td [ngClass]="{'positive': player.plusMinus > 0, 'negative': player.plusMinus < 0}">
                {{ player.plusMinus > 0 ? '+' : '' }}{{ player.plusMinus }}
              </td>

              <td>{{ player.shots }}</td>
              <td>{{ player.shotPercentage }}%</td>
              <td>{{ player.hits }}</td>
              <td>{{ player.blockedShots }}</td>
              <td>{{ player.penaltyMinutes }}</td>
              <td>{{ player.powerPlayGoals }}</td>
              <td>{{ player.shortHandedGoals }}</td>
              <td>{{ player.gameWinningGoals }}</td>
              <td>{{ player.interceptions }}</td>
              <td>{{ player.takeaways }}</td>
              <td>{{ player.giveaways }}</td>
              <td>{{ player.passAttempts }}</td>
              <td>{{ player.passes }}</td>
              <td>{{ player.passPercentage }}%</td>
              <td>{{ player.faceoffsWon }}</td>
              <td>{{ player.faceoffsLost }}</td>
              <td>{{ player.faceoffPercentage }}%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- No Stats Message -->
    <div *ngIf="groupedStats.length === 0" class="no-data-container">
      <p>No player statistics available for the selected season.</p>
    </div>
    
    <!-- Stats Legend -->
    <div class="schedule-legend" *ngIf="!isLoading">
      <div class="legend-item">
        <span class="legend-abbr">Pos</span> - Position
        <span class="legend-abbr">GP</span> - Games Played
        <span class="legend-abbr">G</span> - Goals
        <span class="legend-abbr">A</span> - Assists
        <span class="legend-abbr">PTS</span> - Points
        <span class="legend-abbr">+/-</span> - Plus/Minus
        <span class="legend-abbr">S</span> - Shots
        <span class="legend-abbr">S%</span> - Shot Percentage
      </div>
      <div class="legend-item">
        <span class="legend-abbr">H</span> - Hits
        <span class="legend-abbr">BS</span> - Blocked Shots
        <span class="legend-abbr">PIM</span> - Penalty Minutes
        <span class="legend-abbr">TK</span> - Takeaways
        <span class="legend-abbr">GV</span> - Giveaways
      </div>
      <div class="legend-item">
        <span class="legend-abbr">PPG</span> - Power Play Goals
        <span class="legend-abbr">SHG</span> - Short Handed Goals
        <span class="legend-abbr">GWG</span> - Game Winning Goals
      </div>
      <div class="legend-item">
        <span class="legend-abbr">PA</span> - Pass Attempts
        <span class="legend-abbr">P</span> - Passes
        <span class="legend-abbr">P%</span> - Pass Percentage
        <span class="legend-abbr">FOW</span> - Faceoffs Won
        <span class="legend-abbr">FOL</span> - Faceoffs Lost
        <span class="legend-abbr">FO%</span> - Faceoff Percentage
        <span class="legend-abbr">INT</span> - Interceptions
      </div>
    </div>
  </div>
</div>
